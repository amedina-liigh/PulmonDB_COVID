---
title: "PulmonDB - COVID19."
subtitle: "Regulons Exploration: lung"
date: "`r Sys.Date()`"
author: "Monica Padilla"
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 3
    code_folding: hide
    theme: cosmo
    highlight: textmate
    df_print: paged # kable, tibble
params:
  celllines : 0
  organs : 0
  lung : 1
  ## dirs
  inputdir : ../regulons-analysis/out/lung-bladesdel/
  outdir : ../regulons-analysis/out/lung-bladesdel/plots/
  ## files
  TF_Family_DBD_hsapiens_db : /home/user/Documents/mpadilla/dbs/TF_Family_DBD-hsapiens.csv # cisBP tf family info
  metadata.fn : /home/user/Documents/mpadilla/COVID19/pyscenic/regulons-analysis/out/lung-bladesdel/blanco2020-desai2020-delorey2021_allLungSamples_ID-source-disease.csv # experiment metadata
  ## From pyscenic
  auc_mtx.fn : auc_mtx.RData
  RSS.fn : RSSs.csv # Regulons Specificity Scores
  tfs.fn : tfs780-ordered.txt # TF as outputted from scenic loom, only through scenic counts filter
  tfs_targets.fn : tfs_targets.RData
  ## From reticulateEnrich_.R
  l2fc.fn : log2fc_aucmtx.csv
  # DA tests pvalues
  adj_pvals_mwu.fn : pvalues-mwu-2t-adjusted.csv
  adj_pvals_klm.fn : pvalues-klm-2t-adjusted.csv
  pval_mwu.fn : pvalues-mwu-2t.csv
  pval_klm.fn : pvalues-klm-2t.csv
  # selected regulons
  tfs_DA_enrichLFC_2t.fn : tfs_DA01_enrichLFC_2t.RData
  tfs_DA_2t.fn : tfs_mwu_ks_fdr01-2t.RData # tfs_mwu_ks_fdr24-2t.RData

---

```{r, eval=FALSE, echo=FALSE}
# global variables
# para probar el codigo sin hacer knit
params <- {}
params$celllines <- 0
params$organs <- 0
params$lung <- 1
# dirs
params$inputdir <- "/home/user/Documents/mpadilla/COVID19/pyscenic/regulons-analysis/out/lung-bladesdel/"
params$outdir <- "/home/user/Documents/mpadilla/COVID19/pyscenic/regulons-analysis/out/lung-bladesdel/plots/"
# files
params$TF_Family_DBD_hsapiens_db <- "/home/user/Documents/mpadilla/dbs/TF_Family_DBD-hsapiens.csv"
params$metadata.fn <- "/home/user/Documents/mpadilla/COVID19/pyscenic/regulons-analysis/out/lung-bladesdel/blanco2020-desai2020-delorey2021_allLungSamples_ID-source-disease.csv"
## From pyscenic
params$auc_mtx.fn <- "auc_mtx.RData"
params$RSS.fn <- "RSSs.csv"
params$tfs.fn <- "tfs780-ordered.txt"
params$tfs_targets.fn <- "tfs_targets_fltr.RData"
## From reticulateEnrich.R
params$l2fc.fn <- "log2fc_aucmtx.csv"
# DA tests pvalues
params$adj_pvals_mwu.fn <- "pvalues-mwu-2t-adjusted.csv"
params$adj_pvals_klm.fn <- "pvalues-klm-2t-adjusted.csv"
params$pval_mwu.fn <- "pvalues-mwu-2t.csv"
params$pval_klm.fn <- "pvalues-klm-2t.csv"
# selected regulons
#params$tfs_DA_enrichLFC_2t.fn <- "tfs_DA01_enrichLFC_2t.RData"
#params$tfs_DA_2t.fn <- "tfs_mwu_ks_fdr01-2t.RData" # tfs_mwu_ks_fdr24-2t.RData
params$tfs_DA_enrichLFC_2t.fn <- "tfs_DA1_enrichLFC_2t.RData" 
params$tfs_DA_2t.fn <- "tfs_mwu_ks_fdr1-2t.RData
```


\

## **Exploration of Regulons based on DA and RSS specificity**

### **Preparation**

Load libraries and `regs-analysis.R` script.

```{r, message=FALSE, warning=FALSE}
library(tidyverse) # data handling: dplyr, stringr
library(ComplexHeatmap) # graphics
library(circlize) # colors for complexheatmap
# library(RColorBrewer) # colors
library(org.Hs.eg.db) # orgDB hsapiens annotations
library(ggpubr) ## ggarrange
library(enrichplot) # graphics
library(clusterProfiler) # Biological Terms enrichment analysis + dot plots
library(pathview)
library(DOSE)
library(wordcloud)
library(RColorBrewer)

## Load functions
source("/home/user/Documents/mpadilla/COVID19/pyscenic/regulons-analysis/scripts/regs-analysis.R")

## also, move to folder of report, otherwise it wont run without rendering
```

Load general data and tidy:

```{r, message=FALSE, warning=FALSE}
## Load Data
# Load data: Experiment Metadata
meta <- as.data.frame(read_csv(params$metadata.fn, col_names = T))
meta <- meta %>% filter(disease == "Y") %>% select(source) %>% distinct()

# Load data: auc_mtx
auc_mtx <- as.data.frame(readRDS(paste0(params$inputdir,params$auc_mtx.fn)))

# Load data: TFs names (in order after just scenic counts cutoff)
tfs <- as.data.frame(read_csv(paste0(params$inputdir,params$tfs.fn), col_names = F))[,1]
tfs <- stringr::str_remove(tfs, "_\\(\\+\\)")
tfs <- tfs[match(str_remove(colnames(auc_mtx),"_\\(\\+\\)"),tfs)]

# Load data: tf targets (regulons)
tfs_targets <- readRDS(paste0(params$inputdir,params$tfs_targets.fn))

# Load data: RSS matrix
rss <- as.data.frame(read_csv(paste0(params$inputdir,params$RSS.fn), col_names = T))
rss <- column_to_rownames(rss, var="...1")
# rownames(rss) <- rownames(rss)[match(colnames(auc_mtx),rownames(rss))]
rownames(rss) <- rownames(rss)[match(str_replace(tfs,"$","_\\(\\+\\)"),rownames(rss))]

# Load and tidy data: log 2 FC (auc_mtx)
l2fc <- as.data.frame(read_csv(paste0(params$inputdir,params$l2fc.fn), col_names = T))
# rownames(l2fc) <- colnames(auc_mtx)
rownames(l2fc) <- str_replace(tfs,"$","_\\(\\+\\)")
head(l2fc)

# Load data: mwu adj pvalues
adj_pvals_mwu.fn <- paste0(params$inputdir,params$adj_pvals_klm.fn)
pvalues <- as.data.frame(read_csv(adj_pvals_mwu.fn, col_names = T))
rownames(pvalues) <- tfs
# selected regs - 2tailed tests + rss
tfs_da.fn <- paste0(params$inputdir,params$tfs_DA_2t.fn)
tfs_da <- readRDS(tfs_da.fn)
tfs_da_enrich.fn <- paste0(params$inputdir, params$tfs_DA_enrichLFC_2t.fn)
tfs_da_enrich <- readRDS(tfs_da_enrich.fn)
names(tfs_da_enrich) <- names(tfs_da)
```

Define genes universe and graph number of genes per regulon:

```{r, message=FALSE, warning=FALSE}
# universe of genes = all genes from all tested regulons (after scenic iterations cutoff)
genes_universe <- c()
n.genes.per.reg <- c()
tested.regs <- names(tfs_targets) %in% str_replace(tfs, "$", "_\\(\\+\\)")
for (i in 1:length(names(tfs_targets))) {
  if(tested.regs[i]){
    genes_universe <- c(genes_universe,
                        str_remove(names(tfs_targets[i]), "_\\(\\+\\)"), # tf
                        unname(unlist(tfs_targets[i]))) # gene targets
    n.genes.per.reg <- c(n.genes.per.reg, length(unname(unlist(tfs_targets[i]))))
  }
}
genes_universe.df <- bitr(unique(genes_universe), fromType = "SYMBOL",
        toType = c("ENSEMBL", "ENTREZID"),
        OrgDb = org.Hs.eg.db)
genes_universe <- genes_universe.df$ENTREZID # subset to genes found in OrgDb
#genes_universe <- symbol2EntrezID(genenames = unique(genes_universe))
names(n.genes.per.reg) <- tfs
summary(n.genes.per.reg)

# graph # target genes per regulon histogram
n.genes.per.reg <- as.data.frame(n.genes.per.reg)
p <- ggplot(n.genes.per.reg,aes(n.genes.per.reg)) + #<<
    geom_bar(fill="#8274c9") + # geom hist didnt work
    scale_x_binned() +
    labs(x="# target genes per regulon", y="") +
    geom_vline(xintercept = mean(n.genes.per.reg$n.genes.per.reg), color = "red") +
    geom_vline(xintercept = median(n.genes.per.reg$n.genes.per.reg), color = "blue")
p + annotate("text", x = 3500, y = 450,
             label = c(summary(n.genes.per.reg)[3,])) +
  annotate("text", x = 3500, y = 550,
             label = c(summary(n.genes.per.reg)[4,]))
## save to png
# png(paste0(params$outdir,"hist_genesxregulon.png"), width = 600, height = 200)
# p + annotate("text", x = 3500, y = 450,
#              label = c(summary(n.genes.per.reg)[3,])) +
#   annotate("text", x = 3500, y = 550,
#              label = c(summary(n.genes.per.reg)[4,]))
# dev.off()
```

Make lists of regulons defined as upregulated or downregulated:

```{r, message=FALSE, warning=FALSE}
## Make lists of up/down regulons
tfs_da_up = list()
tfs_da_down = list()
tfs_da_enrich_up = list()
tfs_da_enrich_down = list()
for (exp in names(tfs_da)) {
  tfs_da_up[[exp]] <- tfs_da[[exp]][tfs_da[[exp]] %in%  rownames(l2fc)[which(l2fc[exp] > 0)]]
  tfs_da_down[[exp]] <- tfs_da[[exp]][tfs_da[[exp]] %in% rownames(l2fc)[which(l2fc[exp] < 0)]]
  tfs_da_enrich_up[[exp]] <- intersect(tfs_da_enrich[[exp]], tfs_da_up[[exp]])
  tfs_da_enrich_down[[exp]] <- intersect(tfs_da_enrich[[exp]], tfs_da_down[[exp]])
}
```


### **Plots: DA**

#### Regs

Upregulated Regulons:

```{r}
str_remove(unlist(tfs_da_up), "_\\(\\+\\)")
```

Downregulated Regulons:

```{r}
str_remove(unlist(tfs_da_down), "_\\(\\+\\)")
```


#### **Heatmap auc_mtx**

```{r, message=FALSE, warning=FALSE}
## Load and tidy data to plot: pvalues adjusted of regulons in DA [UP|DOWN]

# Load metadata to name samples as experiments
meta2 <- as.data.frame(read_csv(params$metadata.fn, col_names = T))

# Load and tidy data: adjusted pvalues, format
auc_mtx.hm <- auc_mtx
colnames(auc_mtx.hm) <- tfs

# rearrange meta as in auc_mtx
meta2 <- meta2[match(rownames(auc_mtx.hm),meta2$ID),]
meta2$source_num <- paste0(meta2$source,"-",1:78)
rownames(auc_mtx.hm) <- meta2$source_num
paste0("using auc_mtx")
```

**Basic heatmap**

Regulons that passed `Mann Whitney` and `Kolmogrov` Tests for Differential Activation with and `FDR Adjusted Pval of <= 0.2`.

```{r, message=FALSE, warning=FALSE}

# heatmap colors
max.auc = max(apply(auc_mtx, 1, max))
median.auc = summary(apply(auc_mtx, 1, sum)/length(colnames(auc_mtx)))[3]
min.auc = min(apply(auc_mtx, 1, min))
col_fun = colorRamp2(c(max.auc, median.auc, min.auc), c("red", "white", "steelblue1")) # red is cool, blue is bad pval

# retrieve regs/tfs in DA
selectedTFs <- selectTFs(tfs_per_exp_list = tfs_da_up) ## subset for COVID - 19 samples
# subset pvalues for selectedTFs
auc_mtx.hm <- as.matrix(auc_mtx.hm[,colnames(auc_mtx.hm) %in% selectedTFs])
hm <- Heatmap(auc_mtx.hm, name = "AUC", col = col_fun,
         column_title = "Per Tissue Upregulated Regulons",
         column_title_gp = gpar(fontsize = 5, fontface = "bold"),
         column_names_gp = gpar(fontsize = 10), 
        row_names_gp = gpar(fontsize = 4))
hm
# save to png
# png(paste0(params$outdir,"heatmap_upreg.png"), width = 600, height = 600)
# hm
# dev.off()


# clustering order
d <- dist(auc_mtx.hm, method = "euclidean") # distance matrix
fit <- hclust(d)
plot(fit)
# save to png
# png(paste0(params$outdir,"dendogram_heatmap_upreg.png"), width = 1800, height = 600)
# plot(fit)
# dev.off()
```

Heatmaps showing AUC values for the subset of regulons that were Differentially Activated - upregulated in SARS-CoV-2 infection experiments per cell line.

**TF family info**

```{r, message=FALSE, warning=FALSE}
## Tf families annotation
tf_fam_dbd <- family_annot(tfs_interest = colnames(auc_mtx.hm))
cols.tfs <- rainbow(n = length(unique(tf_fam_dbd$Family_Name))) # colors vector
names(cols.tfs) <- unique(tf_fam_dbd$Family_Name)

# rearrange matrix in TF family order
auc_mtx.hm <- auc_mtx.hm[,match(tf_fam_dbd$TF_Name,colnames(auc_mtx.hm))]

## Prepare Heatmap annotations
order <- c(70,26,39,6,43,3,35,36,18,69,78,32,37,56,41,30,16,42,10,58,47,57,72,33,65,75,52,73,31,49,59,12,50,9,13,8,15,38,19,28,17,5,68,7,53,60,55,74,23,2,25,21,22,1,24,44,20,54,29,34,4,71,62,66,76,64,67,40,46,48,63,77,51,61,11,45,14,27)
nums <- str_remove(rownames(auc_mtx.hm), "\\w+-")
auc_mtx.hm <- auc_mtx.hm[match(order, nums),]

meta2 <- meta2[match(rownames(auc_mtx.hm), meta2$source_num),]

## COVID
covid <- meta2$disease
cols.covid <- RColorBrewer::brewer.pal(n=2, name = "Accent")
names(cols.covid) <- unique(covid)
cols.covid <- cols.covid[1:2]

## Plots

# TF family annotation
h1 <- HeatmapAnnotation(TF_family = tf_fam_dbd$Family_Name, 
                        col = list(TF_family = cols.tfs),
                        annotation_name_side = "left", 
                        annotation_name_gp = gpar(fontsize = 9),
                        annotation_legend_param = 
                          list(TF_family = list(direction = "horizontal", 
                                                nrow = 3)))
# experiment cell lines and treatment annotation
h2 <- rowAnnotation(COVID = covid,
                    annotation_name_gp = gpar(fontsize = 9),
                        col = list(COVID = cols.covid),
                        annotation_legend_param = list(
                          COVID = list(direction = "horizontal", nrow = 1)))
## regs_heatmap_DA_[UP|DOWN]_tffam.png
htmp <- Heatmap(auc_mtx.hm, name = "AUC", cluster_columns = FALSE, col = col_fun,
        column_title = "COVID-19 Upregulated Regulons",
        column_title_gp = gpar(fontsize = 12, fontface = "bold"),
        column_names_gp = gpar(fontsize = 3),
        row_names_gp = gpar(fontsize = 6),
        bottom_annotation = h1, right_annotation = h2,
        heatmap_legend_param = list(direction = "horizontal"))

draw(htmp, merge_legend = TRUE, heatmap_legend_side = "bottom",
    annotation_legend_side = "bottom")

## regs_heatmap_DA_[UP|DOWN]_tffam_tfclust.png
htmp <- Heatmap(auc_mtx.hm, name = "AUC", cluster_columns = TRUE, col = col_fun,
        column_title = "COVID-19 Upregulated Regulons",
        column_title_gp = gpar(fontsize = 12, fontface = "bold"),
        column_names_rot = 45, column_names_gp = gpar(fontsize = 10),
        row_names_gp = gpar(fontsize = 6),
        bottom_annotation = h1, right_annotation = h2,
        heatmap_legend_param = list(direction = "horizontal"))

draw(htmp, merge_legend = TRUE, heatmap_legend_side = "bottom",
    annotation_legend_side = "bottom")
## save to png
# png(paste0(params$outdir,"heatmap_upreg_annot-tf-covid.png"), 
#     width = 600, height = 400)
# draw(htmp, merge_legend = TRUE, heatmap_legend_side = "bottom",
#     annotation_legend_side = "bottom")
# dev.off()
```

#### **GO Enrichment Analysis**

```{r, message=FALSE, warning=FALSE}
# Load and tidy data: regulons/tfs that were in DA + enriched
# Store all genes from all upregulated regulons per experiment to search for enriched terms
regs_genes_per_exp <- regsGenesPerExp(tfs_per_exp_list = tfs_da_up, tfs_targets = tfs_targets, entrezids = T)
```

Number of genes in all regulons per experiment

```{r, message=FALSE, warning=FALSE}
# number of genes in all regulons per experiment
t(as.data.frame(lapply(regs_genes_per_exp, length)))
```

GO:BP analysis

```{r, message=FALSE, warning=FALSE}
# Perform GO Enrichment Analysis on regulons per experiment case
# BP Biological Process, CC Cellular Component, MF Molecular Functions
ego_perexp_da <- list()
i <- 1
for (regs in regs_genes_per_exp) {
  ego <- enrichGO(gene = regs, universe = genes_universe, #  change
                OrgDb = org.Hs.eg.db, ont = "BP", pAdjustMethod = "BH", pvalueCutoff  = 0.01,
                qvalueCutoff  = 0.05, readable = TRUE)
  ego_perexp_da[i] <- list(ego)
  i=i+1
}
names(ego_perexp_da) <- names(regs_genes_per_exp)

## Generate Dotplots iteratively
plots <- iterDotplot(ego_perexp_da, db = "GO:BP", savepngs = F, outdir = params$outdir, test_name = "upregulated")
plots
```

#### **KEGG Enrichment Analysis**

```{r, message=FALSE, warning=FALSE, eval=FALSE}
# Perform KEGG Pathway over-representation Analysis on regulons per experiment case
kk_perexp_da <- list()
i <- 1
for (regs in regs_genes_per_exp) {
  kk <- enrichKEGG(gene = regs, organism = 'hsa', pvalueCutoff = 0.05,
                    pAdjustMethod = "BH", universe = genes_universe)
  kk_perexp_da[i] <- list(kk)
  i=i+1
}
names(kk_perexp_da) <- names(regs_genes_per_exp)

## Generate Dotplots iteratively
plots <- iterDotplot(kk_perexp_da, db = "KEGG", savepngs = F, outdir = params$outdir, test_name = "upregulated")
# names(plots) <- names(ego_perexp_da)
plots
```

#### **Disease Ontology Enrichment Analysis**

DOSE supports enrichment analysis of Disease Ontology (DO) (Schriml et al. 2011), Network of Cancer Gene (A. et al. 2016) and Disease Gene Network (DisGeNET) (Janet et al. 2015).

```{r,message=FALSE, warning=FALSE}
# Perform Disease Enrichment Analysis qith only the tfs (no target genes) Per Tissue case
edo_perexp_da <- list()
i <- 1
for (regs in regs_genes_per_exp) {
  edo <- enrichDO(gene = regs, pvalueCutoff = 0.1, ont = "DO",
                    pAdjustMethod = "BH", universe = genes_universe)
  edo_perexp_da[i] <- list(edo)
  i=i+1
}
names(edo_perexp_da) <- names(regs_genes_per_exp)

## Generate Dotplots iteratively
plots <- iterDotplot(edo_perexp_da, db = "DO", savepngs = F, outdir = params$outdir, test_name = "upregulated-rss")
plots ## nothing
```

**DisGeNet**

```{r,message=FALSE, warning=FALSE}
## Enrich DisGeNet
edgn_perexp_da <- list()
i <- 1
for (regs in regs_genes_per_exp) {
  ego <- enrichDGN(gene = regs, pvalueCutoff = 0.1,
                    pAdjustMethod = "BH", universe =genes_universe)
  edgn_perexp_da[i] <- list(ego)
  i=i+1
}
names(edgn_perexp_da) <- names(regs_genes_per_exp)

## Generate Dotplots iteratively
plots <- iterDotplot(edo_perexp_da, db = "DGN", savepngs = F, outdir = params$outdir, test_name = "upregulated-rss")
plots ## nothing
```





#### **Enrichment Analysis per Regulon**

##### **GO:BO**

Perform Enrichment Analysis runs for all regulons (tfs and target genes)

```{r, message=FALSE, warning=FALSE, eval=FALSE}
# Perform GO Enrichment Analysis on individual regulons
# BP Biological Process, CC Cellular Component, MF Molecular Functions
ego_per_regulon <- list()
for (tf in names(tfs_targets)[names(tfs_targets) %in% tfs_da$Lung]) {
  regulon <- unique(c(str_remove(tf,"_\\(\\+\\)"), tfs_targets[[tf]]))
  ego <- enrichGO(gene = regulon, universe = genes_universe.df$SYMBOL, keyType = "SYMBOL",
                OrgDb = org.Hs.eg.db, ont = "BP", pAdjustMethod = "BH",
                pvalueCutoff  = 0.01, qvalueCutoff  = 0.05, readable = TRUE)
  ego_per_regulon[[tf]] <- ego
}
```

Number of regulons for which at least one enriched term was found:

```{r, message=FALSE, warning=FALSE}
ego_perexp_reg <- list()
i <- 1
for (regs in tfs_da_up$Lung) {
  ego <- enrichGO(gene = regs, universe = genes_universe, #  change
                OrgDb = org.Hs.eg.db, ont = "BP", pAdjustMethod = "BH", pvalueCutoff  = 0.01,
                qvalueCutoff  = 0.05, readable = TRUE)
  ego_perexp_da[i] <- list(ego)
  i=i+1
}
names(ego_perexp_reg) <- names(tfs_da_up$Lung)
```


For each experiment, take GOEA of each regulon and make a cloudplot of the terms:

```{r, message=FALSE, warning=FALSE, eval=FALSE}
# For each experiment, take GOEA of each regulon and make a cloudplot of the terms:
plots_per_exp <- list()
for (exp in names(tfs_per_exp_list)) {
  # Store ego enriched terms per regulon
  terms_perexp <- c()
  for (tf in names(tfs_per_exp_list[[exp]])) {
    # take top n enriched terms per regulon of experiment
    enriched_terms <- as.data.frame(ego_per_regulon[[tf]])[,2]
    enriched_terms <- str_replace_all(enriched_terms," ","_")
    if(length(enriched_terms) > n){
      enriched_terms <- enriched_terms[1:n]
    }
    terms_perexp <- c(terms_perexp, enriched_terms)
    wordcloud(terms_perexp, max.words = 1,
                                    colors = RColorBrewer::brewer.pal(1,name = "Paired"))
  }
  plots_per_exp[[exp]] <- wordcloud(terms_perexp, max.words = 1,
                                    colors = RColorBrewer::brewer.pal(1,name = "Paired"))
}
```

##### **KEGG**

### **Plots: DA+enrichment Regulon Selection**

#### **Heatmap**

```{r, message=FALSE, warning=FALSE}
## Load and tidy data
rss <- as.data.frame(read_csv(paste0(params$inputdir,params$RSS.fn), col_names = T))
rss <- column_to_rownames(rss, var="...1")
rownames(rss) <- str_remove(rownames(rss),"_\\(\\+\\)")
# colnames(rss) <- str_remove(colnames(rss), "[YN]$")
rss <- t(as.matrix(rss))
rss <- rss[,-(which(is.na(apply(rss, 2, sum))))] ## remove tfs with nas

# Load and tidy data: regulons/tfs that were in DA + enriched
## Subset for tfs that were in DA and were enriched in SARSCoV2 experiments
selectedTFsUpLFC <- selectTFs(tfs_per_exp_list = tfs_da_enrich_up)
rssUp <- rss[,match(selectedTFsUpLFC, colnames(rss))]

## down
selectedTFsDownLFC <- selectTFs(tfs_per_exp_list = tfs_da_enrich_down)
rssDown <- rss[,match(selectedTFsDownLFC, colnames(rss))]
```

**Basic heatmap**

```{r, message=FALSE, warning=FALSE}
## Plot
Heatmap(rssUp, name = "RSS",
        column_title = "Per Experiment Most Enriched Upregulated Regulons",
        column_title_gp = gpar(fontsize = 10, fontface = "bold"), column_names_rot = 45,
        column_names_gp = gpar(fontsize = 5), row_names_gp = gpar(fontsize = 10))
```

**Annotating TFs by families**



```{r, message=FALSE, warning=FALSE}
## TF Family annotation
tf_fam_dbd <- family_annot(tfs_interest = colnames(rssUp))
cols.tfs <- rainbow(n = length(unique(tf_fam_dbd$Family_Name))) # colors vector
names(cols.tfs) <- unique(tf_fam_dbd$Family_Name)
# rearrange matrix in tf fam order
rssUp <- rssUp[,match(tf_fam_dbd$TF_Name,colnames(rssUp))]

## highlight immune related tfs
immune.tfs <- rep("No",length(selectedTFsUpLFC))
immune.tfs[tf_fam_dbd$Family_Name %in%
             c("Ets","GATA","IRF","Rel","RFX","SMAD","STAT","ARID/BRIGHT","HSF","p53")] <- "Yes"
cols.tfsi <- c("#c51b7d","#7fbc41") # colors vector
names(cols.tfsi) <- c("Yes","No")

## COVID19
covid <- rep("No",length(rownames(rssUp)))
covid[str_detect(rownames(rssUp),"Y")] <- "Yes"
cols.covid <- RColorBrewer::brewer.pal(n=2, name = "Accent")
names(cols.covid) <- unique(covid)
cols.covid <- cols.covid[1:2]

# reorder experiments in matrix by clustering order
# if(params$sub_cases_rss_plots == 1){
#   exp.sorted <- rownames(rss)[order(rownames(rss))]
#   rss <- rss[match(exp.sorted,rownames(rss)),]
#   if(params$celllines == 1){
#     order <- c(2,5,4,10,7,8,9,1,6,11,3)
#     rss <- rss[order,]
#   }
# }
order <- c(3,14,13,1,12,5,11,4,7,10,8,15,2,6,9)
rssUp <- rssUp[order,]

## Celllines and infection annotation
if(params$celllines==1){
  ## sc2 infected
  sc2_infected <- rep("No",length(rownames(rssUp)))
  sc2_infected[str_detect(rownames(rssUp),"SARSCoV2")] <- "Yes"
  cols.sc2 <- RColorBrewer::brewer.pal(n=2, name = "Set3")
  names(cols.sc2) <- unique(sc2_infected)
  cols.sc2 <- cols.sc2[1:2]
}

# heatmap colors
# col_fun = colorRamp2(c(0, 0.2, 0.23, 0.4), c("blue", "white","indianred1", "red3"))
## plot RSS metric colors
max.rss = max(apply(rssUp, 1, max))
firstqrt.rss = mean(apply(rssUp, 1, summary)[2,])
thirdqrt.rss = mean(apply(rssUp, 1, summary)[5,])
mean.rss = mean(apply(rssUp, 1, summary)[3,])
#min.rss = min(apply(rssUp, 1, min))
col_fun = colorRamp2(c(0.4, thirdqrt.rss, firstqrt.rss, 0), c("red3", "indianred1", "white", "blue"))

## Plot
h1 <- HeatmapAnnotation(TF_family = tf_fam_dbd$Family_Name, Immune_TF = immune.tfs,
                        col = list(TF_family = cols.tfs, Immune_TF = cols.tfsi),
                        annotation_name_side = "left",
                        annotation_legend_param =
                          list(TF_family = list(direction = "horizontal", nrow = 3),
                               Immune_TF = list(direction = "horizontal", nrow = 1)))
# covid annotation
h2 <- rowAnnotation(COVID = covid,
                    annotation_name_gp = gpar(fontsize = 9),
                        col = list(COVID = cols.covid),
                        annotation_legend_param = list(
                          COVID = list(direction = "horizontal", nrow = 1)))
htmp <- Heatmap(rssUp, name = "RSS", cluster_columns = FALSE, col = col_fun,
        column_title = "Per Experiment Most Enriched Upregulated Regulons",
        column_title_gp = gpar(fontsize = 15, fontface = "bold"),
        column_names_rot = 45, column_names_gp = gpar(fontsize = 5),
        row_names_gp = gpar(fontsize = 9),
        bottom_annotation = h1, right_annotation = h2,
        heatmap_legend_param = list(direction = "horizontal"))

draw(htmp, merge_legend = TRUE, heatmap_legend_side = "bottom",
    annotation_legend_side = "bottom")
## save to png
# png(paste0(params$outdir,"heatmap_upreg_enrich_tfannot_notfclust.png"), width = 900, height = 600)
# draw(htmp, merge_legend = TRUE, heatmap_legend_side = "bottom",
#     annotation_legend_side = "bottom")
# dev.off()

# cluster TFs
htmp <- Heatmap(rssUp, name = "RSS", cluster_columns = TRUE, col = col_fun,
        column_title = "Per Experiment Most Enriched Upregulated Regulons",
        column_title_gp = gpar(fontsize = 15, fontface = "bold"),
        column_names_rot = 45, column_names_gp = gpar(fontsize = 5),
        row_names_gp = gpar(fontsize = 9),
        bottom_annotation = h1, right_annotation = h2,
        heatmap_legend_param = list(direction = "horizontal"))

draw(htmp, merge_legend = TRUE, heatmap_legend_side = "bottom",
    annotation_legend_side = "bottom")
## save to png
# png(paste0(params$outdir,"heatmap_upreg_enrich_tfannot_tfclust.png"), width = 900, height = 600)
# draw(htmp, merge_legend = TRUE, heatmap_legend_side = "bottom",
#     annotation_legend_side = "bottom")
# dev.off()
```

Heatmap only showing infected or treated samples:

```{r, message=FALSE, warning=FALSE}
## removing controls
rssUp.nc <- rssUp[str_detect(rownames(rssUp),"Mock")==F,]
## sc2 infected bar
sc2_infected <- rep("No",length(rownames(rssUp.nc)))
sc2_infected[str_detect(rownames(rssUp.nc),"SARSCoV2")] <- "Yes"
cols.sc2 <- RColorBrewer::brewer.pal(n=2, name = "Set3")
names(cols.sc2) <- unique(sc2_infected)
cols.sc2 <- cols.sc2[1:2]
## Plot
h2 <- rowAnnotation(SARSCov2 = sc2_infected, annotation_name_gp = gpar(fontsize = 9),
                        col = list(SARSCov2 = cols.sc2),
                        annotation_legend_param = list(SARSCov2 = list(direction = "horizontal", nrow = 1)))
# cluster TFs
htmp <- Heatmap(rssUp.nc, name = "RSS", cluster_columns = TRUE, col = col_fun,
        column_title = "Per Experiment Most Enriched Upregulated Regulons",
        column_title_gp = gpar(fontsize = 15, fontface = "bold"),
        column_names_rot = 45, column_names_gp = gpar(fontsize = 3),
        row_names_gp = gpar(fontsize = 8),
        bottom_annotation = h1, right_annotation = h2,
        heatmap_legend_param = list(direction = "horizontal"))

draw(htmp, merge_legend = TRUE, heatmap_legend_side = "bottom",
    annotation_legend_side = "bottom")
# ## save to png
# png(paste0(params$outdir,"heatmap_upreg_enrich_tfannot_tfclust_subInf.png"), width = 900, height = 600)
# draw(htmp, merge_legend = TRUE, heatmap_legend_side = "bottom",
#     annotation_legend_side = "bottom")
# dev.off()
```

removing Calu3 DA + enriched regulons

```{r, message=FALSE, warning=FALSE}
selectedTFsUpLFC <- selectTFs(tfs_per_exp_list = tfs_da_enrich_up[c(6:8,10)])
rssUp.nc2 <- rssUp.nc[,match(selectedTFsUpLFC, colnames(rssUp.nc))]
## TF Family annotation
tf_fam_dbd <- family_annot(tfs_interest = colnames(rssUp.nc2))
cols.tfs <- rainbow(n = length(unique(tf_fam_dbd$Family_Name))) # colors vector
names(cols.tfs) <- unique(tf_fam_dbd$Family_Name)
# rearrange matrix in tf fam order
rssUp.nc2 <- rssUp.nc2[,match(tf_fam_dbd$TF_Name,colnames(rssUp.nc2))]

## highlight immune related tfs
immune.tfs <- rep("No",length(selectedTFsUpLFC))
immune.tfs[tf_fam_dbd$Family_Name %in%
             c("Ets","GATA","IRF","Rel","RFX","SMAD","STAT","ARID/BRIGHT","HSF","p53")] <- "Yes"
cols.tfsi <- c("#c51b7d","#7fbc41") # colors vector
names(cols.tfsi) <- c("Yes","No")
## Plot
h1 <- HeatmapAnnotation(TF_family = tf_fam_dbd$Family_Name, Immune_TF = immune.tfs,
                        col = list(TF_family = cols.tfs, Immune_TF = cols.tfsi),
                        annotation_name_side = "left",
                        annotation_legend_param =
                          list(TF_family = list(direction = "horizontal", nrow = 3),
                               Immune_TF = list(direction = "horizontal", nrow = 1)))
# cluster TFs
htmp <- Heatmap(rssUp.nc2, name = "RSS", cluster_columns = TRUE, col = col_fun,
        column_title = "Per Experiment Most Enriched Upregulated Regulons",
        column_title_gp = gpar(fontsize = 15, fontface = "bold"),
        column_names_rot = 45, column_names_gp = gpar(fontsize = 10),
        row_names_gp = gpar(fontsize = 10),
        bottom_annotation = h1, right_annotation = h2,
        heatmap_legend_param = list(direction = "horizontal"))

draw(htmp, merge_legend = TRUE, heatmap_legend_side = "bottom",
    annotation_legend_side = "bottom")
## save to png
# png(paste0(params$outdir,"heatmap_upreg_enrich_tfannot_tfclust_subInf_nosc2calu3regs.png"), width = 900, height = 400)
# draw(htmp, merge_legend = TRUE, heatmap_legend_side = "bottom",
#     annotation_legend_side = "bottom")
# dev.off()
```

Only show Calu3 SARS-CoV-2 regulons

```{r, message=FALSE, warning=FALSE}
selectedTFsUpLFC <- selectTFs(tfs_per_exp_list = tfs_da_enrich_up[9])
rssUp.nc3 <- rssUp.nc[,match(selectedTFsUpLFC, colnames(rssUp.nc))]
## TF Family annotation
tf_fam_dbd <- family_annot(tfs_interest = colnames(rssUp.nc3))
cols.tfs <- rainbow(n = length(unique(tf_fam_dbd$Family_Name))) # colors vector
names(cols.tfs) <- unique(tf_fam_dbd$Family_Name)
# rearrange matrix in tf fam order
rssUp.nc3 <- rssUp.nc3[,match(tf_fam_dbd$TF_Name,colnames(rssUp.nc3))]

## highlight immune related tfs
immune.tfs <- rep("No",length(selectedTFsUpLFC))
immune.tfs[tf_fam_dbd$Family_Name %in%
             c("Ets","GATA","IRF","Rel","RFX","SMAD","STAT","ARID/BRIGHT","HSF","p53")] <- "Yes"
cols.tfsi <- c("#c51b7d","#7fbc41") # colors vector
names(cols.tfsi) <- c("Yes","No")
# change experiment names
rownames(rssUp.nc3) <- str_remove(rownames(rssUp.nc3), "_infected")
rownames(rssUp.nc3) <- str_remove(rownames(rssUp.nc3), "_treated")
## Plot
h1 <- HeatmapAnnotation(TF_family = tf_fam_dbd$Family_Name, Immune_TF = immune.tfs,
                        col = list(TF_family = cols.tfs, Immune_TF = cols.tfsi),
                        annotation_name_side = "left",
                        annotation_legend_param =
                          list(TF_family = list(direction = "horizontal", nrow = 3),
                               Immune_TF = list(direction = "horizontal", nrow = 1)))
# cluster TFs
htmp <- Heatmap(rssUp.nc3, name = "RSS", cluster_columns = TRUE, col = col_fun,
        column_title = "Per Experiment Most Enriched Upregulated Regulons",
        column_title_gp = gpar(fontsize = 15, fontface = "bold"),
        column_names_gp = gpar(fontsize = 6),
        row_names_gp = gpar(fontsize = 5),
        bottom_annotation = h1, right_annotation = h2,
        heatmap_legend_param = list(direction = "horizontal"))

draw(htmp, merge_legend = TRUE, heatmap_legend_side = "bottom",
    annotation_legend_side = "bottom")
# ## save to png
# png(paste0(params$outdir,"heatmap_upreg_enrich_tfannot_tfclust_subInf_sc2calu3regs.png"), width = 1000, height = 600)
# draw(htmp, merge_legend = TRUE, heatmap_legend_side = "bottom",
#     annotation_legend_side = "bottom")
# dev.off()
```

#### **GO Term Enrichment Analysis**

```{r, message=FALSE, warning=FALSE}
library(clusterProfiler)
library(org.Hs.eg.db)
library(enrichplot)

# Load and tidy data: regulons/tfs that were in DA + enriched
# Store all genes from all upregulated regulons per experiment to search for enriched terms
regs_genes_per_exp <- regsGenesPerExp(tfs_per_exp_list = tfs_da_enrich_up, tfs_targets = tfs_targets, entrezids = T)
```

Number of genes in all regulons per experiment

```{r, message=FALSE, warning=FALSE}
# number of genes in all regulons per experiment
t(as.data.frame(lapply(regs_genes_per_exp, length)))
```

```{r, message=FALSE, warning=FALSE}
# Perform GO Enrichment Analysis on regulons per experiment case
# BP Biological Process, CC Cellular Component, MF Molecular Functions
ego_perexp_da <- list()
i <- 1
for (regs in regs_genes_per_exp) {
  ego <- enrichGO(gene = regs, universe = genes_universe, #  change
                OrgDb = org.Hs.eg.db, ont = "BP", pAdjustMethod = "BH", pvalueCutoff  = 0.01,
                qvalueCutoff  = 0.05, readable = TRUE)
  ego_perexp_da[i] <- list(ego)
  i=i+1
}
names(ego_perexp_da) <- names(regs_genes_per_exp)

## Generate Dotplots iteratively
plots <- iterDotplot(ego_perexp_da, db = "GO:BP", savepngs = F, outdir = params$outdir, test_name = "upregulated-rss")
plots
# if(params$celllines==1){
#   # display plots together
#   p <- ggarrange(plots$IAVdNS1_infected_NHBE,plots$human_IFNB_treated_NHBE, ncol = 2, nrow = 1)
#   annotate_figure(p, top = text_grob("GO:BP Enriched Terms in Upregulated+Enriched Regulons",
#                                      face = "bold", size = 14))
#   p <- ggarrange(plots$SARSCoV2_infected_A549_hACE2,plots$SARSCoV2_infected_A549_hACE2_pt,
#                  plots$SARSCoV2_infected_Calu3,ncol = 3, nrow = 1)
#   annotate_figure(p, top = text_grob("GO:BP Enriched Terms in Upregulated+Enriched Regulons",
#                                      face = "bold", size = 14))
# }
```

#### **KEGG Enrichment Analysis**

```{r, message=FALSE, warning=FALSE, eval=FALSE}
# Perform KEGG Pathway over-representation Analysis on regulons per experiment case
kk_perexp_da <- list()
i <- 1
for (regs in regs_genes_per_exp) {
  kk <- enrichKEGG(gene = regs, organism = 'hsa', pvalueCutoff = 0.05,
                    pAdjustMethod = "BH", universe = genes_universe)
  kk_perexp_da[i] <- list(kk)
  i=i+1
}
names(kk_perexp_da) <- names(regs_genes_per_exp)

## Generate Dotplots iteratively
plots <- iterDotplot(kk_perexp_da, db = "KEGG", savepngs = F, outdir = params$outdir, test_name = "upregulated-rss")
plots
```


#### **Disease Ontology Enrichment Analysis**

DOSE supports enrichment analysis of Disease Ontology (DO) (Schriml et al. 2011), Network of Cancer Gene (A. et al. 2016) and Disease Gene Network (DisGeNET) (Janet et al. 2015).

```{r,message=FALSE, warning=FALSE}
library(DOSE)
# Perform Disease Enrichment Analysis qith only the tfs (no target genes) per experiment case
edo_perexp_da <- list()
i <- 1
for (regs in regs_genes_per_exp) {
  edo <- enrichDO(gene = regs, pvalueCutoff = 0.1, ont = "DO",
                    pAdjustMethod = "BH", universe = genes_universe)
  edo_perexp_da[i] <- list(edo)
  i=i+1
}
names(edo_perexp_da) <- names(regs_genes_per_exp)

## Generate Dotplots iteratively
plots <- iterDotplot(edo_perexp_da, db = "DO", savepngs = T, outdir = params$outdir, test_name = "upregulated-rss")
plots
```


### **References**


[1] https://www.cienciadedatos.net/documentos/19b_comparaciones_multiples_correccion_p-value_fdr

[2] https://yulab-smu.top/biomedical-knowledge-mining-book/clusterprofiler-go.html

```{r}
sessionInfo()
```
